# [ARCHIVED] architecture-modular

> **å½’æ¡£æ—¥æœŸ**: 2026-02-11
> **åŸå› **: è®¾è®¡å·²è¿­ä»£/åŠŸèƒ½å·²å®ç°/æ–¹æ¡ˆå·²åºŸå¼ƒ
> **æœ€æ–°çŠ¶æ€è§**: README.md / DESIGN.md / ROADMAP.md

---

# Quant-Lab æ¶æ„è®¾è®¡ - æ¨¡å—åŒ–èµ›è½¦åŸç†

> é›¶ä»¶å®Œå¤‡ â†’ æŒ‰å›¾çº¸ç»„è£… â†’ ä¼˜è´¨èµ›è½¦

---

## æ¶æ„åŸåˆ™

1. **å•ä¸€èŒè´£** - ä¸€ä¸ªæ¨¡å—åªåšä¸€ä»¶äº‹ï¼Œåšå¥½ä¸€ä»¶äº‹
2. **æ˜¾å¼ä¾èµ–** - ä¾èµ–æ³¨å…¥ï¼Œä¸éšå¼å…¨å±€
3. **æ¥å£éš”ç¦»** - æ¨¡å—é—´é€šè¿‡æ¥å£é€šä¿¡
4. **å¯æ›¿æ¢** - ä»»ä½•æ¨¡å—éƒ½å¯ mock/æ›¿æ¢
5. **å¯ç»„è£…** - æŒ‰éœ€ç»„åˆï¼Œä¸å¼ºåˆ¶å…¨ç”¨

---

## æ¨¡å—åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: ç­–ç•¥å±‚ (User Code)                                 â”‚
â”‚  â”œâ”€â”€ ç­–ç•¥è„šæœ¬ (st_init/st_heartbeat/st_exit)                â”‚
â”‚  â””â”€â”€ ç”¨æˆ·è‡ªå®šä¹‰é€»è¾‘                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 3: è¿è¡Œæ—¶å±‚ (Runtime)                                 â”‚
â”‚  â”œâ”€â”€ StrategyRunner    â† ç”Ÿå‘½å‘¨æœŸç®¡ç† + æ¨¡å—ç»„è£…             â”‚
â”‚  â”œâ”€â”€ StateManager      â† çŠ¶æ€æŒä¹…åŒ– (å¯ç‹¬ç«‹ä½¿ç”¨)             â”‚
â”‚  â””â”€â”€ SignalHandler     â† è¿›ç¨‹ç®¡ç† (å¯ç‹¬ç«‹ä½¿ç”¨)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: èƒ½åŠ›å±‚ (Capabilities)                              â”‚
â”‚  â”œâ”€â”€ APIProvider       â† äº¤æ˜“æ‰€æ¥å£ (å¯ç‹¬ç«‹ä½¿ç”¨)             â”‚
â”‚  â”œâ”€â”€ IndicatorEngine   â† æŒ‡æ ‡è®¡ç®— (çº¯å‡½æ•°ï¼Œæ— çŠ¶æ€)           â”‚
â”‚  â”œâ”€â”€ DataFeed          â† è¡Œæƒ…æ•°æ® (å¯ç‹¬ç«‹ä½¿ç”¨)               â”‚
â”‚  â””â”€â”€ Notifier          â† é€šçŸ¥ (å¯ç‹¬ç«‹ä½¿ç”¨)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: åŸºç¡€è®¾æ–½å±‚ (Infrastructure)                        â”‚
â”‚  â”œâ”€â”€ TimerScheduler    â† å®šæ—¶ä»»åŠ¡ (å·²å®Œå¤‡âœ…)                â”‚
â”‚  â”œâ”€â”€ Storage           â† å­˜å‚¨æŠ½è±¡ (DuckDB)                   â”‚
â”‚  â””â”€â”€ Logger            â† æ—¥å¿— (ç®€å•console)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. StateManager (çŠ¶æ€æŒä¹…åŒ–)

**èŒè´£**: è‡ªåŠ¨ä¿å­˜/æ¢å¤ç­–ç•¥çŠ¶æ€  
**è¾“å…¥**: key-value æ•°æ®  
**è¾“å‡º**: æŒä¹…åŒ–æ–‡ä»¶  
**ä¾èµ–**: æ—  (çº¯æ–‡ä»¶æ“ä½œ)  
**å¯ç‹¬ç«‹ä½¿ç”¨**: âœ…

```typescript
const state = new StateManager({ strategyId: 'my-strat' });
await state.load();
state.set('key', value);  // è‡ªåŠ¨ä¿å­˜
```

---

### 2. SignalHandler (è¿›ç¨‹ä¿¡å·)

**èŒè´£**: ä¼˜é›…å¤„ç† SIGINT/SIGTERM/å¼‚å¸¸  
**è¾“å…¥**: å›è°ƒå‡½æ•°  
**è¾“å‡º**: ä¿¡å·äº‹ä»¶  
**ä¾èµ–**: æ—  (çº¯ Node.js process)  
**å¯ç‹¬ç«‹ä½¿ç”¨**: âœ…

```typescript
const signals = new SignalHandler();
signals.onGracefulShutdown(async () => {
  await cleanup();
});
```

---

### 3. APIProvider (äº¤æ˜“æ‰€æ¥å£)

**èŒè´£**: ç»Ÿä¸€äº¤æ˜“æ‰€ API è°ƒç”¨  
**è¾“å…¥**: é…ç½® (key/secret/proxy)  
**è¾“å‡º**: æ ‡å‡†æ¥å£ (getPositions/placeOrder)  
**ä¾èµ–**: æ—  (çº¯ç½‘ç»œè¯·æ±‚)  
**å¯ç‹¬ç«‹ä½¿ç”¨**: âœ…

```typescript
const bybit = new BybitProvider({ 
  accountId: 'wjcgm@bbt-sub1',
  proxy: 'http://127.0.0.1:8890'  // å…³é”®ï¼
});
const positions = await bybit.getPositions();
```

---

### 4. IndicatorEngine (æŒ‡æ ‡è®¡ç®—)

**èŒè´£**: çº¯å‡½æ•°æŒ‡æ ‡è®¡ç®—  
**è¾“å…¥**: ä»·æ ¼æ•°ç»„  
**è¾“å‡º**: æŒ‡æ ‡æ•°ç»„  
**ä¾èµ–**: æ—  (çº¯æ•°å­¦è®¡ç®—)  
**å¯ç‹¬ç«‹ä½¿ç”¨**: âœ…

```typescript
import { sma, macd, rsi } from '@moltbaby/quant-lib';
const sma20 = sma(closes, 20);
```

---

### 5. StrategyRunner (ç»„è£…å™¨)

**èŒè´£**: ç»„è£…æ‰€æœ‰æ¨¡å—ï¼Œæ‰§è¡Œç­–ç•¥ç”Ÿå‘½å‘¨æœŸ  
**è¾“å…¥**: ç­–ç•¥ä»£ç  + é…ç½®  
**è¾“å‡º**: è¿è¡ŒçŠ¶æ€  
**ä¾èµ–**: StateManager, SignalHandler, APIProvider (æ³¨å…¥)  
**å¯ç‹¬ç«‹ä½¿ç”¨**: âŒ (éœ€è¦å…¶ä»–æ¨¡å—)

```typescript
const runner = new StrategyRunner({
  stateManager: new StateManager(...),
  signalHandler: new SignalHandler(),
  apiProvider: new BybitProvider(...),
});
```

---

## æ¨¡å—è€¦åˆå…³ç³»

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Strategy  â”‚ (User Code)
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ uses
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚    ctx      â”‚ (Context)
                    â”‚  - state    â”‚
                    â”‚  - api      â”‚
                    â”‚  - log      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
   â”‚ State   â”‚      â”‚  Signal   â”‚     â”‚   API     â”‚
   â”‚ Manager â”‚      â”‚ Handler   â”‚     â”‚ Provider  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–²                  â–²                  â–²
        â”‚                  â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ injects
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚   Runner    â”‚ (Assembler)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾èµ–æ–¹å‘**: Runner â†’ å…¶ä»–æ¨¡å— â†’ åŸºç¡€è®¾æ–½  
**æ— å¾ªç¯ä¾èµ–**: âœ…  
**å¯ Mock æµ‹è¯•**: âœ…

---

## å…³é”®è®¾è®¡å†³ç­–

### âœ… å¥½çš„è®¾è®¡

1. **StateManager ç‹¬ç«‹** - ä¸ä¾èµ– Runnerï¼Œå¯å•ç‹¬ä½¿ç”¨
2. **SignalHandler ç‹¬ç«‹** - çº¯è¿›ç¨‹ç®¡ç†ï¼Œä¸è€¦åˆä¸šåŠ¡
3. **APIProvider ç‹¬ç«‹** - ç»Ÿä¸€æ¥å£ï¼Œäº¤æ˜“æ‰€å¯åˆ‡æ¢
4. **çº¯å‡½æ•°æŒ‡æ ‡** - æ— çŠ¶æ€ï¼Œå¯æµ‹è¯•
5. **Context æ³¨å…¥** - ç­–ç•¥é€šè¿‡ ctx è®¿é—®èƒ½åŠ›ï¼Œä¸æ˜¾å¼ä¾èµ–

### âŒ é¿å…çš„è®¾è®¡

1. **å…¨å±€çŠ¶æ€** - ä¸ç”¨å…¨å±€å˜é‡ï¼Œå…¨éƒ¨æ³¨å…¥
2. **éšå¼ä¾èµ–** - ä¸ç”¨ process.env éšå¼è¯»å–ï¼Œæ˜¾å¼ä¼ å‚
3. **å¤§è€Œå…¨çš„ç±»** - ä¸ç”¨ God Classï¼Œæ‹†å°æ¨¡å—
4. **æ·±å±‚ç»§æ‰¿** - ä¸ç”¨ç»§æ‰¿é“¾ï¼Œç”¨ç»„åˆ
5. **å¼ºåˆ¶ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½** - æ¨¡å—å¯ç‹¬ç«‹ä½¿ç”¨

---

## ä½¿ç”¨æ–¹å¼ï¼ˆæŒ‰éœ€ç»„è£…ï¼‰

### æ–¹å¼ 1: å®Œæ•´ä½¿ç”¨ (StrategyRunner ç»„è£…)

```typescript
import { StrategyRunner } from 'quant-lab';

const runner = new StrategyRunner({
  workDir: './my-strategy',
});

await runner.run('./strategy.ts', {
  strategyId: 'grid-001',
  symbol: 'BTCUSDT',
});
```

**é€‚åˆ**: ç”Ÿäº§ç¯å¢ƒï¼Œéœ€è¦å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†

---

### æ–¹å¼ 2: ç‹¬ç«‹ä½¿ç”¨ StateManager

```typescript
import { StateManager } from 'quant-lab';

const state = new StateManager({
  strategyId: 'my-script',
  stateDir: './state',
});

await state.load();
state.set('counter', state.get('counter', 0) + 1);
// è‡ªåŠ¨ä¿å­˜
```

**é€‚åˆ**: ç®€å•è„šæœ¬ï¼Œä¸éœ€è¦å®Œæ•´ç­–ç•¥æ¡†æ¶

---

### æ–¹å¼ 3: ç‹¬ç«‹ä½¿ç”¨ API

```typescript
import { BybitProvider } from 'quant-lab';

const bybit = new BybitProvider({
  accountId: 'wjcgm@bbt-sub1',
  proxy: 'http://127.0.0.1:8890',
});

const positions = await bybit.getPositions();
console.log(positions);
```

**é€‚åˆ**: ä¸´æ—¶æŸ¥è¯¢ã€è„šæœ¬ã€æµ‹è¯•

---

### æ–¹å¼ 4: ç‹¬ç«‹ä½¿ç”¨æŒ‡æ ‡

```typescript
import { sma, macd, rsi } from 'quant-lab';

const data = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
const sma5 = sma(data, 5);
const rsi14 = rsi(data, 14);
```

**é€‚åˆ**: æ•°æ®åˆ†æã€å›æµ‹ã€å¤–éƒ¨å·¥å…·

---

## å½“å‰çŠ¶æ€æ£€æŸ¥

| æ¨¡å— | å®Œå¤‡æ€§ | ç‹¬ç«‹æ€§ | å¯æµ‹è¯• |
|------|--------|--------|--------|
| StateManager | 90% | âœ… å¯ç‹¬ç«‹ | âœ… |
| SignalHandler | 90% | âœ… å¯ç‹¬ç«‹ | âœ… |
| APIProvider | 70% | âœ… å¯ç‹¬ç«‹ | âš ï¸ éœ€ Mock |
| Indicator | 80% | âœ… çº¯å‡½æ•° | âœ… |
| StrategyRunner | 70% | âŒ éœ€ç»„è£… | âš ï¸ éœ€é›†æˆæµ‹è¯• |

---

## ä¸‹ä¸€æ­¥å»ºè®®

**ç²¾ç®€æ–¹å‘**: 
1. âœ… å½“å‰æ¨¡å—æ‹†åˆ†åˆç†
2. âœ… ä¾èµ–å…³ç³»æ¸…æ™°
3. âš ï¸ éœ€è¦è¡¥å……ï¼šæ¨¡å—æ¥å£å®šä¹‰ (Interface)
4. âš ï¸ éœ€è¦è¡¥å……ï¼šMock å®ç°ç”¨äºæµ‹è¯•

**æµ‹è¯•ç­–ç•¥**:
- å•å…ƒæµ‹è¯•ï¼šæ¯ä¸ªæ¨¡å—ç‹¬ç«‹æµ‹è¯•
- é›†æˆæµ‹è¯•ï¼šæ¨¡å—ç»„åˆæµ‹è¯•
- E2Eæµ‹è¯•ï¼šå®Œæ•´ç­–ç•¥æµ‹è¯•

è¿™æ ·è®¾è®¡ç¬¦åˆèµ›è½¦åŸç†å—ï¼ŸğŸ¦€
