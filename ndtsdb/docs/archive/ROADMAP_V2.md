# data-lib 下一阶段研究计划

## 🎯 目标

将 data-lib 从"高性能时序存储"升级为"生产级多维时序数据库"

---

## 📋 研究议题

### 1. 存储引擎优化

#### 1.1 压缩算法
- **现状**: 无压缩，原始二进制存储
- **研究**: 
  - Gorilla 压缩 (Facebook，时序专用)
  - LZ4 压缩 (速度优先)
  - Zstd 压缩 (压缩率优先)
- **预期**: 存储减少 50-90%，查询性能保持 80%+

#### 1.2 内存映射 (mmap)
- **现状**: 全量加载到内存
- **研究**:
  - 热数据内存缓存
  - 冷数据 mmap 读取
  - LRU 缓存策略
- **预期**: 支持 >10GB 数据集，启动速度提升 10x

#### 1.3 分区策略优化
- **现状**: 简单时间分区
- **研究**:
  - 多级分区 (年/月/日)
  - 自动分区合并
  - 分区裁剪优化

### 2. 查询引擎

#### 2.1 SQL 子集支持
- **现状**: 只有 API 查询
- **研究**:
  - SQL 解析器 (子集)
  - WHERE 条件优化
  - JOIN 支持 (ASOF JOIN)
  - 子查询 (有限支持)

#### 2.2 索引系统
- **现状**: 仅 Symbol 索引
- **研究**:
  - B-Tree 时间索引
  - Bitmap 索引 (低基数列)
  - Bloom Filter (快速排除)

#### 2.3 查询优化器
- **研究**:
  - 谓词下推
  - 分区裁剪
  - 向量化执行

### 3. 数据类型扩展

#### 3.1 更多类型
- **现状**: int64, float64, int32
- **研究**:
  - Decimal (精确小数，金融场景)
  - VARCHAR (可变长度字符串)
  - JSON (半结构化数据)
  - Array (数组类型)

#### 3.2 编码优化
- **现状**: Symbol 字典编码
- **研究**:
  - Delta 编码 (时间戳)
  - Run-Length 编码 (重复值)
  - Bit-packing (整数)

### 4. 高可用与持久化

#### 4.1 WAL 优化
- **现状**: 简单 JSON Lines WAL
- **研究**:
  - 二进制 WAL 格式
  - 批量提交
  - 崩溃恢复

#### 4.2 备份与复制
- **研究**:
  - 增量备份
  - 快照机制
  - 主从复制 (只读副本)

#### 4.3 云存储集成
- **研究**:
  - S3/MinIO 冷存储
  - 自动分层 (热/温/冷)
  - Parquet 格式导出

### 5. 高级特性

#### 5.1 流式处理
- **研究**:
  - 实时数据摄入
  - 滑动窗口聚合
  - 流式 JOIN

#### 5.2 物化视图
- **研究**:
  - 自动维护的聚合视图
  - 增量更新

#### 5.3 UDF (用户定义函数)
- **研究**:
  - JavaScript UDF
  - WASM UDF (高性能)

### 6. 性能极致化

#### 6.1 SIMD 进一步优化
- **现状**: C FFI 基础 SIMD
- **研究**:
  - AVX2 指令 (256-bit)
  - AVX-512 (512-bit)
  - ARM NEON (Apple Silicon)

#### 6.2 并行查询
- **研究**:
  - Worker 线程并行
  - 分区并行扫描
  - 并行聚合

#### 6.3 GPU 加速 (远期)
- **研究**:
  - CUDA/WebGPU 聚合
  - 大规模数据分析

---

## 🏆 优先级建议

### P0 (核心功能)
1. SQL 子集支持 (大幅降低使用门槛)
2. 内存映射 (支持大数据集)
3. 压缩算法 (节省存储成本)

### P1 (性能优化)
4. SIMD 进一步优化 (AVX2/NEON)
5. 并行查询 (多核利用)
6. 索引系统 (查询加速)

### P2 (企业特性)
7. 备份与复制 (生产必备)
8. 云存储集成 (弹性扩展)
9. 物化视图 (分析场景)

### P3 (高级特性)
10. 流式处理 (实时分析)
11. GPU 加速 (超大规模)

---

## 📊 参考竞品

| 特性 | QuestDB | ClickHouse | TimescaleDB | data-lib 目标 |
|------|---------|------------|-------------|---------------|
| SQL 支持 | 完整 | 完整 | 完整 (PG) | 子集 |
| 压缩 | 是 | 是 | 是 | 是 |
| 分区 | 是 | 是 | 是 | 是 |
| 索引 | 有限 | 是 | 是 | 有限 |
| 复制 | 企业版 | 是 | 是 | 研究 |
| 云存储 | 企业版 | 是 | 部分 | 研究 |
| 体积 | 80MB | 200MB+ | 100MB+ | <1MB |

---

## 🚀 下一步建议

**建议先实现 P0 功能，让 data-lib 达到"可用"状态：**

1. **SQL 解析器** (1-2周)
   - 手写递归下降解析器
   - 支持 SELECT/WHERE/GROUP BY/ORDER BY
   - 集成到 ColumnarTable

2. **内存映射** (1周)
   - Bun mmap API 调研
   - 实现惰性加载
   - LRU 缓存

3. **Gorilla 压缩** (1周)
   - 实现浮点数 Gorilla 编码
   - 实现时间戳 Delta-of-Delta 编码
   - 对比存储节省

**完成后 data-lib 将具备：**
- SQL 查询能力
- 大数据集支持 (>10GB)
- 50-90% 存储节省
- 仍是 <1MB 体积

---

## 🤔 需要讨论的问题

1. **SQL 支持程度**：完整 SQL 还是子集？
2. **网络接口**：需要 HTTP/TCP 服务器吗？
3. **事务支持**：需要 ACID 吗？
4. **并发模型**：单线程还是多线程？

请指示优先研究哪个方向！
