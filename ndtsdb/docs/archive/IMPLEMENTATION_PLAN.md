# data-lib å…¨å¸‚åœºå›æ”¾å®æ–½è®¡åˆ’

## ğŸ¯ ç›®æ ‡

å®ç°åŸºäº **mmap + zero-copy** çš„å…¨å¸‚åœºå›æ”¾ç³»ç»Ÿï¼Œæ”¯æŒ 3000+ äº§å“åŒæ—¶å›æ”¾ã€‚

---

## ğŸ“‹ ç°çŠ¶åˆ†æ

### å·²æœ‰åŸºç¡€
- âœ… Symbol åˆ†åŒºå­˜å‚¨ï¼ˆé«˜æ€§èƒ½å†™å…¥ï¼‰
- âœ… Gorilla å‹ç¼©ï¼ˆ3-8GB æ•°æ®é‡ï¼‰
- âœ… ColumnarTable åˆ—å¼å­˜å‚¨
- âœ… C FFI SIMD åŠ é€Ÿ

### éœ€è¦æ–°å¢
- MmapPoolï¼ˆå†…å­˜æ˜ å°„æ± ï¼‰
- Zero-copy åˆ—è¯»å–
- æ™ºèƒ½é¢„è¯»ç­–ç•¥
- å¤šè·¯å½’å¹¶æµ

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å›æµ‹å¼•æ“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ç­–ç•¥1       â”‚  â”‚ ç­–ç•¥2       â”‚  â”‚ ç­–ç•¥N       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MmapMergeStreamï¼ˆå¤šè·¯å½’å¹¶ï¼‰                  â”‚
â”‚  - 3000è·¯æ—¶é—´æˆ³å¯¹é½                                       â”‚
â”‚  - æ»‘åŠ¨çª—å£é¢„è¯»                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MmapPoolï¼ˆå†…å­˜æ˜ å°„æ± ï¼‰                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ AAPL    â”‚ â”‚ GOOGL   â”‚ â”‚ ...     â”‚                   â”‚
â”‚  â”‚ (mmap)  â”‚ â”‚ (mmap)  â”‚ â”‚ (mmap)  â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                          â”‚
â”‚  Virtual Memory: ~300GB                                  â”‚
â”‚  Physical Memory: 1-2GB (active window)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OS Page Cacheï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰                    â”‚
â”‚  - LRU æ¢å‡ºç­–ç•¥                                          â”‚
â”‚  - é¡ºåºè¯»ä¼˜åŒ–                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç£ç›˜ (3000ä¸ªæ–‡ä»¶)                         â”‚
â”‚  data/AAPL.bin  data/GOOGL.bin  ...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“… è¿­ä»£è®¡åˆ’

### é˜¶æ®µ 1: MmapPool åŸºç¡€ (Day 1-2)

**ç›®æ ‡**: å»ºç«‹å†…å­˜æ˜ å°„æ± ï¼Œæ”¯æŒ zero-copy è¯»å–

**ä»»åŠ¡**:
1. [ ] å°è£… `mmap()` ç³»ç»Ÿè°ƒç”¨
2. [ ] å®ç° `MmappedColumnarTable` ç±»
3. [ ] å®ç° zero-copy `getColumn()`
4. [ ] åŸºç¡€æµ‹è¯•

**äº§å‡º**:
- `src/mmap/pool.ts`
- `src/mmap/table.ts`
- `tests/mmap-basic.ts`

**éªŒæ”¶æ ‡å‡†**:
```typescript
const pool = new MmapPool();
await pool.init(['AAPL', 'GOOGL']);
const prices = pool.getColumn('AAPL', 'price');  // zero-copy
console.log(prices);  // Float64Array (è§†å›¾ï¼Œéæ‹·è´)
```

---

### é˜¶æ®µ 2: æ™ºèƒ½é¢„è¯» (Day 3)

**ç›®æ ‡**: å®ç°æ»‘åŠ¨çª—å£é¢„è¯»ç­–ç•¥

**ä»»åŠ¡**:
1. [ ] `madvise()` å°è£…ï¼ˆSEQUENTIAL, WILLNEED, DONTNEEDï¼‰
2. [ ] `SmartPrefetcher` æ»‘åŠ¨çª—å£å®ç°
3. [ ] é¢„è¯»æ€§èƒ½æµ‹è¯•

**äº§å‡º**:
- `src/mmap/prefetcher.ts`
- `tests/prefetcher.ts`

**éªŒæ”¶æ ‡å‡†**:
```typescript
const prefetcher = new SmartPrefetcher(pool);
await prefetcher.slideWindow(symbols, 0);  // é¢„è¯»çª—å£å†…æ•°æ®
// ç‰©ç†å†…å­˜ < 2GB
```

---

### é˜¶æ®µ 3: å¤šè·¯å½’å¹¶ (Day 4-5)

**ç›®æ ‡**: å®ç° 3000 è·¯æ—¶é—´æˆ³å¯¹é½å½’å¹¶

**ä»»åŠ¡**:
1. [ ] `MmapMergeStream` å¤šè·¯å½’å¹¶å®ç°
2. [ ] æ—¶é—´æˆ³å¯¹é½é€»è¾‘
3. [ ] å›æ”¾é€Ÿåº¦æ§åˆ¶
4. [ ] æ€§èƒ½ä¼˜åŒ–

**äº§å‡º**:
- `src/mmap/merge.ts`
- `tests/merge-stream.ts`

**éªŒæ”¶æ ‡å‡†**:
```typescript
const stream = new MmapMergeStream();
await stream.init(symbols);
for (const batch of stream.replay()) {
  console.log(batch.timestamp, batch.prices);  // æ‰€æœ‰äº§å“åŒä¸€æ—¶åˆ»
}
```

---

### é˜¶æ®µ 4: é›†æˆæµ‹è¯• (Day 6)

**ç›®æ ‡**: å®Œæ•´å›æµ‹æµç¨‹éªŒè¯

**ä»»åŠ¡**:
1. [ ] 3000 äº§å“åŠ è½½æµ‹è¯•
2. [ ] å›æ”¾æ€§èƒ½åŸºå‡†æµ‹è¯•
3. [ ] å†…å­˜å ç”¨ç›‘æ§
4. [ ] ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

**äº§å‡º**:
- `tests/full-replay.ts`
- `docs/BENCHMARK.md`

**éªŒæ”¶æ ‡å‡†**:
- åŠ è½½ 3000 äº§å“æ—¶é—´: < 30ç§’
- å›æ”¾é€Ÿåº¦: > 10M ticks/ç§’
- ç‰©ç†å†…å­˜å ç”¨: < 4GB
- å»¶è¿Ÿ: < 1ms

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å…³é”® API

```typescript
// mmap å°è£…
function mmap(size: number, fd: number, offset?: number): ArrayBuffer;
function munmap(buffer: ArrayBuffer): void;
function madvise(buffer: ArrayBuffer, advice: number): void;

// madvise å¸¸é‡
const MADV_NORMAL = 0;       // é»˜è®¤
const MADV_SEQUENTIAL = 2;   // é¡ºåºè®¿é—®ï¼ˆé¢„è¯»ä¼˜åŒ–ï¼‰
const MADV_WILLNEED = 3;     // å³å°†éœ€è¦ï¼ˆå¼‚æ­¥é¢„åŠ è½½ï¼‰
const MADV_DONTNEED = 4;     // ä¸å†éœ€è¦ï¼ˆé‡Šæ”¾ç‰©ç†å†…å­˜ï¼‰
```

### æ•°æ®ç»“æ„

```typescript
interface MmappedColumnarTable {
  path: string;
  fd: number;
  buffer: ArrayBuffer;        // mmap æ˜ å°„çš„ç¼“å†²åŒº
  size: number;
  header: {
    version: number;
    rowCount: number;
    columns: Map<string, {
      type: ColumnarType;
      offset: number;
      byteLength: number;
    }>;
  };
}

interface MmapPool {
  maps: Map<string, MmappedColumnarTable>;
  maxActiveMaps: number;
  
  init(symbols: string[]): Promise<void>;
  getColumn(symbol: string, column: string): TypedArray;
  advise(symbol: string, columns: string[], advice: number): void;
  close(): void;
}

interface MmapMergeStream {
  pool: MmapPool;
  cursors: Map<string, number>;
  
  init(symbols: string[]): Promise<void>;
  replay(): Generator<{ timestamp: bigint; prices: Map<string, number> }>;
}
```

---

## ğŸ“Š æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | ç°çŠ¶ | æå‡ |
|------|--------|------|------|
| åŠ è½½ 3000 äº§å“ | < 30s | ä¸æ”¯æŒ | - |
| å›æ”¾é€Ÿåº¦ | > 10M ticks/s | - | - |
| ç‰©ç†å†…å­˜å ç”¨ | < 4GB | - | - |
| å»¶è¿Ÿ | < 1ms | - | - |
| CPU å ç”¨ | < 50% | - | - |

---

## ğŸš€ å¼€å§‹å®æ–½

### ç¬¬ä¸€æ­¥: æ£€æŸ¥ç³»ç»Ÿæ”¯æŒ

```bash
# æ£€æŸ¥å¤§é¡µæ”¯æŒ
cat /proc/meminfo | grep HugePages

# æ£€æŸ¥ç³»ç»Ÿ mmap é™åˆ¶
ulimit -v  # è™šæ‹Ÿå†…å­˜é™åˆ¶

# æµ‹è¯•æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½
fio --name=test --filename=/data/test --direct=1 --rw=read --bs=4k --size=1G
```

### ç¬¬äºŒæ­¥: å®ç° MmapPool

```typescript
// src/mmap/pool.ts
export class MmapPool {
  // å®ç°...
}
```

### ç¬¬ä¸‰æ­¥: æµ‹è¯•éªŒè¯

```bash
bun run tests/mmap-basic.ts
bun run tests/prefetcher.ts
bun run tests/merge-stream.ts
bun run tests/full-replay.ts
```

---

## ğŸ“ æ–‡æ¡£æ›´æ–°

- [x] `docs/MMAP_ZEROCOPY.md` - æŠ€æœ¯æ–¹æ¡ˆ
- [x] `docs/IMPLEMENTATION_PLAN.md` - æœ¬æ–‡ä»¶
- [ ] `docs/API.md` - API æ–‡æ¡£ (Day 6)
- [ ] `docs/BENCHMARK.md` - æ€§èƒ½æŠ¥å‘Š (Day 6)

---

**å¼€å§‹æ—¶é—´**: 2026-02-09
**é¢„è®¡å®Œæˆ**: 2026-02-14
**è´Ÿè´£äºº**: OpenClaw

---

## ğŸ’¡ å…³é”®æé†’

1. **ä¸è¦è‡ªå·±ç®¡ç†å†…å­˜** - è®© OS é¡µç¼“å­˜åš LRU
2. **å–„ç”¨ madvise** - ç»™ OS æ˜ç¡®çš„é¢„è¯»æç¤º
3. **Zero-copy æ˜¯å…³é”®** - é¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´
4. **æµ‹è¯•é©±åŠ¨** - æ¯ä¸ªé˜¶æ®µéƒ½è¦æœ‰æ˜ç¡®çš„éªŒæ”¶æ ‡å‡†

**ç«‹å³å¼€å§‹é˜¶æ®µ 1ï¼**
